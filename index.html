<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPFD Distance Visualizer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        h1 { color: #333; text-align: center; }
        #map { height: 600px; width: 100%; }
        #controls, #search, #presets { margin-bottom: 10px; }
        #search input { width: 300px; }
        select { padding: 5px; margin-right: 10px; }
        #model-viewer { width: 100%; height: 600px; }
    </style>
</head>
<body>
    <h1>EPFD Distance Visualizer</h1>
    <div id="search">
        <input type="text" id="searchInput" placeholder="Search for a location">
        <button onclick="searchLocation()">Search</button>
    </div>
    <div id="controls">
        <label for="distance">Distance (nautical miles): </label>
        <input type="number" id="distance" value="200" min="1">
        <button onclick="updateDistance()">Update Distance</button>
    </div>
    <div id="presets">
        <select id="airportSelect" onchange="selectAirport()">
            <option value="">Select an airport</option>
        </select>
    </div>
    <div id="map"></div>

    <h2>3D Model Viewer</h2>
    <button onclick="toggleModel()">Toggle Model</button>
    <input type="file" id="fileInput" accept=".glb" onchange="loadModel(event)">
    <input type="file" id="skyboxInput" accept="image/*" onchange="loadSkyboxTexture(event)">
    <div id="model-viewer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // Map initialization code (unchanged)
        var map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var distanceNM = 200;
        var customMarker;
        var presetMarker;

        var nasaLogoUrl = 'https://th.bing.com/th/id/R.ae42d855fd2e000889b1733f7833102d?rik=L0xX4U5jfJz7Bw&pid=ImgRaw&r=0';

        var nasaIcon = L.icon({
            iconUrl: nasaLogoUrl,
            iconSize: [44, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });

        const airports = [
            { name: "Grant County International Airport", lat: 47.1949, lon: -119.3208 },
            { name: "King County International Airport", lat: 47.5290, lon: -122.3019 },
            { name: "Paine Field", lat: 47.9063, lon: -122.2815 },
            { name: "Manassas Regional Airport", lat: 38.7214, lon: -77.5151 },
            { name: "Eastern West Virginia Regional Airport", lat: 39.4026, lon: -77.9846 },
            { name: "Dayton International Airport", lat: 39.9024, lon: -84.2194 },
            { name: "Langley Air Force Base", lat: 37.0825, lon: -76.3607 },
            { name: "Norfolk International Airport", lat: 36.8946, lon: -76.2012 },
            { name: "Edwards Air Force Base", lat: 34.9054, lon: -117.8836 },
            { name: "Meadows Field", lat: 35.4339, lon: -119.0578 },
            { name: "Moffett Federal Airfield", lat: 37.4160, lon: -122.0486 },
            { name: "Tucson International Airport", lat: 32.1161, lon: -110.9410 },
            { name: "First Flight Airport", lat: 36.0169, lon: -75.6718 }
        ];

        // Map functions (unchanged)
        function nauticalMilesToMeters(nauticalMiles) {
            return nauticalMiles * 1852;
        }

        function updateDistance() {
            distanceNM = parseInt(document.getElementById('distance').value);
            if (isNaN(distanceNM) || distanceNM < 1) {
                alert("Please enter a valid number greater than 0.");
                return;
            }
            updateCustomCircle();
            updatePresetCircle();
        }

        function searchLocation() {
            var query = document.getElementById('searchInput').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        var lat = parseFloat(data[0].lat);
                        var lon = parseFloat(data[0].lon);
                        map.setView([lat, lon], 10);
                        placeMarkerAndCircle([lat, lon]);
                    } else {
                        alert("Location not found. Please try a different search term.");
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function placeMarkerAndCircle(latlng) {
            if (customMarker) {
                map.removeLayer(customMarker);
            }
            customMarker = L.layerGroup([
                L.marker(latlng, {icon: nasaIcon}),
                L.circle(latlng, {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.3,
                    radius: nauticalMilesToMeters(distanceNM)
                })
            ]).addTo(map);

            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng[0]}&lon=${latlng[1]}`)
                .then(response => response.json())
                .then(data => {
                    var locationName = data.display_name.split(',')[0];
                    customMarker.getLayers()[0].bindPopup(locationName).openPopup();
                })
                .catch(error => console.error('Error:', error));
        }

        function selectAirport() {
            const selectedAirport = document.getElementById('airportSelect').value;
            if (presetMarker) {
                map.removeLayer(presetMarker);
            }
            if (selectedAirport) {
                const airport = airports.find(a => a.name === selectedAirport);
                presetMarker = L.layerGroup([
                    L.marker([airport.lat, airport.lon], {icon: nasaIcon}).bindPopup(airport.name),
                    L.circle([airport.lat, airport.lon], {
                        color: 'blue',
                        fillColor: '#30f',
                        fillOpacity: 0.3,
                        radius: nauticalMilesToMeters(distanceNM)
                    })
                ]).addTo(map);
            }
        }

        function updatePresetCircle() {
            if (presetMarker) {
                map.removeLayer(presetMarker);
                selectAirport();
            }
        }

        function updateCustomCircle() {
            if (customMarker) {
                map.removeLayer(customMarker);
                const latlng = customMarker.getLayers()[0].getLatLng();
                placeMarkerAndCircle([latlng.lat, latlng.lng]);
            }
        }

        const airportSelect = document.getElementById('airportSelect');
        airports.forEach(airport => {
            const option = document.createElement('option');
            option.value = airport.name;
            option.textContent = airport.name;
            airportSelect.appendChild(option);
        });

        map.on('click', function(e) {
            placeMarkerAndCircle([e.latlng.lat, e.latlng.lng]);
        });

        // Three.js 3D Model Viewer
        let scene, camera, renderer, model, controls, skybox;
        let currentModelIndex = 0;
        const modelPaths = ['Models\DHC7 HiFi 2.38_final.glb', 'Models\Gateway Core.glb'];

        function initModelViewer() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / 600, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, 600);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1;
            renderer.outputEncoding = THREE.sRGBEncoding;
            document.getElementById('model-viewer').appendChild(renderer.domElement);

            // Lighting setup
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            camera.position.z = 5;

            // Add OrbitControls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2;

            // Initialize with default skybox
            loadDefaultSkybox();

            animate();
            loadDefaultModel();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (model) {
                model.rotation.y += 0.002; // Slower rotation
            }
            controls.update(); // Update controls in the animation loop
            renderer.render(scene, camera);
        }

        function loadModel(event) {
            const file = event.target.files[0];
            const loader = new THREE.GLTFLoader();
            const reader = new FileReader();

            reader.onload = function(e) {
                const contents = e.target.result;
                loader.parse(contents, '', function(gltf) {
                    addModelToScene(gltf.scene);
                }, undefined, function(error) {
                    console.error(error);
                });
            };

            reader.readAsArrayBuffer(file);
        }

        function loadDefaultModel() {
            const loader = new THREE.GLTFLoader();
            loader.load(modelPaths[currentModelIndex], function(gltf) {
                addModelToScene(gltf.scene);
            }, undefined, function(error) {
                console.error('An error occurred while loading the default model:', error);
            });
        }

        function addModelToScene(newModel) {
            if (model) {
                scene.remove(model);
            }
            model = newModel;
            scene.add(model);

            // Center and scale the model
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 8 / maxDim;
            model.scale.multiplyScalar(scale);
            model.position.sub(center.multiplyScalar(scale));
        }

        function toggleModel() {
            currentModelIndex = (currentModelIndex + 1) % modelPaths.length;
            loadDefaultModel();
        }

        function loadDefaultSkybox() {
            const loader = new THREE.CubeTextureLoader();
            const texture = loader.load([
                'Skybox\Skybox.jpg',
                'Skybox\Skybox.jpg',
                'Skybox\Skybox.jpg',
                'Skybox\Skybox.jpg',
                'Skybox\Skybox.jpg',
                'Skybox\Skybox.jpg',
            ]);
            scene.background = texture;
        }

        function loadSkyboxTexture(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const image = new Image();
                image.onload = function() {
                    const texture = new THREE.Texture(image);
                    texture.needsUpdate = true;
                    const shader = THREE.ShaderLib.equirect;
                    const material = new THREE.ShaderMaterial({
                        fragmentShader: shader.fragmentShader,
                        vertexShader: shader.vertexShader,
                        uniforms: shader.uniforms,
                        depthWrite: false,
                        side: THREE.BackSide
                    });
                    material.uniforms.tEquirect.value = texture;
                    const sphere = new THREE.SphereGeometry(500, 60, 40);
                    skybox = new THREE.Mesh(sphere, material);
                    scene.add(skybox);
                };
                image.src = e.target.result;
            };

            reader.readAsDataURL(file);
        }

        // Handle window resizing
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            camera.aspect = window.innerWidth / 600;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, 600);
        }

        initModelViewer();
    </script>
</body>
</html>

